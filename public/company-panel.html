<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Empresa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Painel da Empresa</h3>
            <button onclick="logout()" class="btn btn-danger">Sair</button>
        </div>

        <!-- Navega√ß√£o por abas -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button" role="tab">
                    <i class="fas fa-mobile-alt"></i> Dispositivos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync" type="button" role="tab">
                    <i class="fas fa-sync-alt"></i> Sincroniza√ß√£o
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Aba Dispositivos (MANT√âM TUDO IGUAL) -->
            <div class="tab-pane fade show active" id="devices" role="tabpanel">
                <div class="card shadow mt-3">
                    <div class="card-body">
                        <!-- Info da Empresa -->
                        <div class="mb-4 p-3 bg-light rounded">
                            <h4>Informa√ß√µes da Empresa</h4>
                            <div class="row">
                                <div class="col-md-4">
                                    <p class="mb-2">Dispositivos: <span id="deviceCount">0</span>/<span id="maxDevices">0</span></p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-2">Validade: <span id="licenseExpiration">-</span></p>
                                </div>
                                <div class="col-md-4">
                                    <div id="warningArea"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Registro de Dispositivo -->
                        <h4>Registrar Novo Dispositivo</h4>
                        <form id="deviceForm" class="mb-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="androidId" placeholder="ID Android" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="description" placeholder="Descri√ß√£o do Dispositivo" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <button type="submit" class="btn btn-primary w-100">Registrar Dispositivo</button>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <!-- Lista de Dispositivos -->
                        <h4>Dispositivos Registrados</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID Android</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Status</th>
                                        <th>√öltimo Acesso</th>
                                        <th>√öltima Sync</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="deviceList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nova Aba Sincroniza√ß√£o -->
            <div class="tab-pane fade" id="sync" role="tabpanel">
                <div class="row mt-3">
                    <!-- Upload de Cargas -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5><i class="fas fa-upload"></i> Enviar Cargas para Dispositivos</h5>
                            </div>
                            <div class="card-body">
                                <form id="uploadForm">
                                    <div class="mb-3">
                                        <label for="loadType" class="form-label">Tipo de Carga</label>
                                        <select class="form-select" id="loadType" required>
                                            <option value="">Selecione...</option>
                                            <option value="parcelas">Parcelas</option>
                                            <option value="parametros">Par√¢metros</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="loadVersion" class="form-label">Vers√£o</label>
                                        <input type="text" class="form-control" id="loadVersion" placeholder="Ex: v1.0, 2025-01-15" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="loadDescription" class="form-label">Descri√ß√£o (opcional)</label>
                                        <input type="text" class="form-control" id="loadDescription" placeholder="Descri√ß√£o da carga">
                                    </div>
                                    <div class="mb-3">
                                        <label for="loadFile" class="form-label">Arquivo CSV</label>
                                        <input type="file" class="form-control" id="loadFile" accept=".csv" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-upload"></i> Enviar Carga
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Cargas Dispon√≠veis -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white d-flex justify-content-between">
                                <h5><i class="fas fa-list"></i> Cargas Dispon√≠veis</h5>
                                <button onclick="loadCargas()" class="btn btn-sm btn-light">
                                    <i class="fas fa-refresh"></i>
                                </button>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                <div id="loadsList">
                                    <p class="text-muted">Carregando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico de Sincroniza√ß√£o -->
                <div class="card mt-4">
                    <div class="card-header bg-info text-white d-flex justify-content-between">
                        <h5><i class="fas fa-history"></i> Hist√≥rico de Sincroniza√ß√£o</h5>
                        <button onclick="loadSyncHistory()" class="btn btn-sm btn-light">
                            <i class="fas fa-refresh"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Dispositivo</th>
                                        <th>Tipo</th>
                                        <th>Arquivo</th>
                                        <th>Tamanho</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="syncHistoryList">
                                    <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===== MANT√âM TODAS AS FUN√á√ïES EXISTENTES =====
        
        // Verifica√ß√£o inicial de autentica√ß√£o
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/';
                return false;
            }
            return true;
        }

        // Fun√ß√£o para carregar informa√ß√µes da empresa
        async function loadCompanyInfo() {
            if (!checkAuth()) return;

            try {
                const response = await fetch('/api/company/info', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    document.getElementById('deviceCount').textContent = data.company.deviceCount || '0';
                    document.getElementById('maxDevices').textContent = data.company.maxDevices || '0';
                    document.getElementById('licenseExpiration').textContent = 
                        data.company.expirationDate ? new Date(data.company.expirationDate).toLocaleDateString() : '-';
                }
            } catch (error) {
                console.error('Erro ao carregar info:', error);
            }
        }

        // Fun√ß√£o para carregar dispositivos (ATUALIZADA com informa√ß√£o de sync)
        async function loadDevices() {
            if (!checkAuth()) return;

            try {
                const response = await fetch('/api/devices/list', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();
                if (data.success && data.devices) {
                    const tbody = document.getElementById('deviceList');
                    tbody.innerHTML = data.devices.map(device => `
                        <tr>
                            <td>${device.androidId}</td>
                            <td>${device.description}</td>
                            <td>
                                <span class="badge ${device.isActive ? 'bg-success' : 'bg-danger'}">
                                    ${device.isActive ? 'Ativo' : 'Inativo'}
                                </span>
                            </td>
                            <td>${device.lastAccess ? new Date(device.lastAccess).toLocaleString() : 'Nunca'}</td>
                            <td>
                                ${device.lastSync ? `
                                    <small>
                                        ${device.lastSync.type === 'upload' ? 'üì§' : 'üì•'} 
                                        ${new Date(device.lastSync.timestamp).toLocaleDateString()}
                                        <br><span class="text-muted">${device.lastSync.filename}</span>
                                    </small>
                                ` : '<span class="text-muted">-</span>'}
                            </td>
                            <td>
                                <button 
                                    onclick="toggleDevice('${device.androidId}')"
                                    class="btn btn-sm ${device.isActive ? 'btn-danger' : 'btn-success'} me-2">
                                    ${device.isActive ? 'Desativar' : 'Ativar'}
                                </button>
                                <button 
                                    onclick="deleteDevice('${device.androidId}')"
                                    class="btn btn-sm btn-danger">
                                    Excluir
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar dispositivos:', error);
            }
        }

        // Registrar dispositivo (MANT√âM IGUAL)
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('deviceForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!checkAuth()) return;

                const androidId = document.getElementById('androidId').value;
                const description = document.getElementById('description').value;

                try {
                    const response = await fetch('/api/devices', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({ androidId, description })
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('deviceForm').reset();
                        await Promise.all([loadCompanyInfo(), loadDevices()]);
                        alert('Dispositivo registrado com sucesso!');
                    } else {
                        throw new Error(data.message || 'Erro ao registrar dispositivo');
                    }
                } catch (error) {
                    alert(error.message || 'Erro ao registrar dispositivo');
                }
            });
        });

        // Ativar/Desativar dispositivo (MANT√âM IGUAL)
        async function toggleDevice(androidId) {
            if (!checkAuth()) return;

            try {
                const response = await fetch(`/api/devices/${androidId}/toggle`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    await Promise.all([loadCompanyInfo(), loadDevices()]);
                } else {
                    alert(data.message || 'Erro ao alterar status do dispositivo');
                }
            } catch (error) {
                alert('Erro ao alterar status do dispositivo');
            }
        }

        // Deletar dispositivo (MANT√âM IGUAL)
        async function deleteDevice(androidId) {
            if (!checkAuth()) return;

            if (!confirm('Tem certeza que deseja excluir este dispositivo? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }

            try {
                const response = await fetch(`/api/devices/${androidId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    await Promise.all([loadCompanyInfo(), loadDevices()]);
                    alert('Dispositivo exclu√≠do com sucesso!');
                } else {
                    throw new Error(data.message || 'Erro ao excluir dispositivo');
                }
            } catch (error) {
                alert(error.message || 'Erro ao excluir dispositivo');
            }
        }

        // ===== NOVAS FUN√á√ïES DE SINCRONIZA√á√ÉO =====

        // Fun√ß√£o para carregar cargas dispon√≠veis
        async function loadCargas() {
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch('/api/admin/loads', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    const loadsList = document.getElementById('loadsList');
                    if (data.loads.length === 0) {
                        loadsList.innerHTML = '<p class="text-muted">Nenhuma carga dispon√≠vel</p>';
                    } else {
                        loadsList.innerHTML = data.loads.map(load => `
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                ${load.type === 'parcelas' ? 'üìç' : '‚öôÔ∏è'} 
                                                ${load.description || load.originalName}
                                            </h6>
                                            <small class="text-muted">
                                                Vers√£o: ${load.version} | 
                                                ${new Date(load.uploadDate).toLocaleDateString()}
                                            </small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button onclick="toggleLoad('${load.id}')" 
                                                    class="btn btn-outline-${load.isActive ? 'success' : 'danger'}">
                                                ${load.isActive ? 'Ativo' : 'Inativo'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar cargas:', error);
                document.getElementById('loadsList').innerHTML = '<p class="text-danger">Erro ao carregar cargas</p>';
            }
        }

        // Fun√ß√£o para ativar/desativar carga
        async function toggleLoad(loadId) {
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`/api/admin/loads/${loadId}/toggle`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    loadCargas();
                } else {
                    alert(data.message || 'Erro ao alterar status da carga');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao alterar status da carga');
            }
        }

        // Fun√ß√£o para carregar hist√≥rico de sincroniza√ß√£o
        async function loadSyncHistory() {
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch('/api/admin/sync/history', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('syncHistoryList');
                    if (data.history.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma sincroniza√ß√£o registrada</td></tr>';
                    } else {
                        tbody.innerHTML = data.history.map(item => `
                            <tr>
                                <td>${new Date(item.timestamp).toLocaleString()}</td>
                                <td>${item.androidId}</td>
                                <td>
                                    <span class="badge ${item.type === 'upload' ? 'bg-info' : 'bg-success'}">
                                        ${item.type === 'upload' ? 'üì§ Upload' : 'üì• Download'}
                                    </span>
                                </td>
                                <td>${item.filename}</td>
                                <td>${formatFileSize(item.fileSize)}</td>
                                <td>
                                    ${item.type === 'upload' ? `
                                        <button onclick="downloadSyncFile('${item.id}')" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-download"></i> Baixar
                                        </button>
                                    ` : '-'}
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
            }
        }

        // Fun√ß√£o para baixar arquivo de sincroniza√ß√£o
        async function downloadSyncFile(syncId) {
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`/api/admin/sync/download/${syncId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'arquivo.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    alert(data.message || 'Erro ao baixar arquivo');
                }
            } catch (error) {
                console.error('Erro no download:', error);
                alert('Erro ao baixar arquivo');
            }
        }

        // Fun√ß√£o para formatar tamanho do arquivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Handle do formul√°rio de upload
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('uploadForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData();
                formData.append('file', document.getElementById('loadFile').files[0]);
                formData.append('type', document.getElementById('loadType').value);
                formData.append('version', document.getElementById('loadVersion').value);
                formData.append('description', document.getElementById('loadDescription').value);

                const token = localStorage.getItem('authToken');

                try {
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

                    const response = await fetch('/api/admin/loads/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Carga enviada com sucesso!');
                        document.getElementById('uploadForm').reset();
                        loadCargas();
                    } else {
                        alert(data.message || 'Erro ao enviar carga');
                    }
                } catch (error) {
                    console.error('Erro no upload:', error);
                    alert('Erro ao enviar carga');
                } finally {
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-upload"></i> Enviar Carga';
                }
            });

            // Carregar hist√≥rico quando a aba de sincroniza√ß√£o for aberta
            document.getElementById('sync-tab').addEventListener('shown.bs.tab', function() {
                loadSyncHistory();
                loadCargas();
            });
        });

        // Fun√ß√£o logout (MANT√âM IGUAL)
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/';
        }

        // Inicializa√ß√£o (ATUALIZADA)
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                Promise.all([loadCompanyInfo(), loadDevices()])
                    .catch(error => console.error('Erro na inicializa√ß√£o:', error));
            }
        });
    </script>
</body>
</html>